// Add to your existing script section:

// 1. Better Error Handling for Price Fetching
async function fetchPrices() {
    if(SCRIPT_URL.includes("REPLACE")) {
        console.warn("Script URL not configured - using default prices");
        return;
    }
    
    const maxRetries = 3;
    let attempt = 0;
    
    while (attempt < maxRetries) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
            
            const response = await fetch(SCRIPT_URL, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Check for error object from backend
            if (data.error) {
                throw new Error(data.error);
            }
            
            if (!Array.isArray(data) || data.length === 0) {
                console.warn("API returned empty or invalid data, using defaults");
                return;
            }

            // Process prices with better matching
            let updatedCount = 0;
            data.forEach(item => {
                const key = mapItemToKey(item);
                if (key && prices.hasOwnProperty(key)) {
                    prices[key] = parseFloat(item.price);
                    updatedCount++;
                    
                    const displayEl = document.getElementById(`price-${key}`);
                    if(displayEl) {
                        displayEl.textContent = `${item.price} EGP/${item.unit}`;
                    }
                }
            });
            
            console.log(`Successfully updated ${updatedCount} prices`);
            calculateTotal();
            return; // Success, exit retry loop
            
        } catch (error) {
            attempt++;
            console.error(`Price fetch attempt ${attempt} failed:`, error.message);
            
            if (attempt >= maxRetries) {
                // Show subtle notification to user
                showNotification("Using cached prices. Some prices may be outdated.", "warning");
            } else {
                // Wait before retry (exponential backoff)
                await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
        }
    }
}

// 2. Improved Item Mapping Function
function mapItemToKey(item) {
    const name = (item.name_en || item.name || "").trim().toLowerCase();
    const desc = (item.description || "").trim().toLowerCase();
    
    // More robust matching logic
    const mappings = {
        'baladi chicken': 'baladi',
        'white chicken': 'white',
        'duck': 'duck',
        'pigeons': 'pigeon',
        'pigeon': 'pigeon',
        'drumsticks': 'drumsticks',
        'wings': 'wings',
        'pure liver': 'liver',
        'liver': 'liver'
    };
    
    // Check direct mappings first
    for (const [key, value] of Object.entries(mappings)) {
        if (name.includes(key)) {
            // Special case for thighs
            if (name.includes('thigh')) {
                return desc.includes('boneless') ? 'boneless_thighs' : 'thighs';
            }
            return value;
        }
    }
    
    // Handle Pane
    if (name.includes('pane')) return 'pane';
    
    // Handle Thighs separately
    if (name.includes('thigh')) {
        return desc.includes('boneless') ? 'boneless_thighs' : 'thighs';
    }
    
    return null;
}

// 3. User Notification System
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'warning' ? '#fff3cd' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
        color: ${type === 'warning' ? '#856404' : type === 'error' ? '#721c24' : '#0c5460'};
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// 4. Enhanced Form Validation
function validateForm() {
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    
    const lang = document.getElementById('mainHtml').classList.contains('lang-ar') ? 'ar' : 'en';
    
    if (name.length < 3) {
        alert(lang === 'en' ? 'Please enter a valid name (at least 3 characters)' : 'يرجى إدخال اسم صحيح (3 أحرف على الأقل)');
        return false;
    }
    
    // Egyptian phone validation (01XXXXXXXXX)
    const phoneRegex = /^01[0-9]{9}$/;
    if (!phoneRegex.test(phone)) {
        alert(lang === 'en' ? 'Please enter a valid Egyptian phone number (01XXXXXXXXX)' : 'يرجى إدخال رقم هاتف مصري صحيح (01XXXXXXXXX)');
        return false;
    }
    
    if (address.length < 10) {
        alert(lang === 'en' ? 'Please provide a detailed address (at least 10 characters)' : 'يرجى تقديم عنوان مفصل (10 أحرف على الأقل)');
        return false;
    }
    
    return true;
}

// 5. Prevent Double Submission
let isSubmitting = false;

document.getElementById('deliveryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Prevent double submission
    if (isSubmitting) {
        console.log('Submission already in progress');
        return;
    }
    
    // Validate form
    if (!validateForm()) return;
    
    const lang = document.getElementById('mainHtml').classList.contains('lang-ar') ? 'ar' : 'en';
    const orderData = getOrderString('en');
    
    // Check minimum order
    const MIN_ORDER = 2000;
    if(orderData.total < MIN_ORDER) {
        alert(lang === 'en' 
            ? `Minimum order is ${MIN_ORDER} EGP. Current total: ${orderData.total} EGP` 
            : `الحد الأدنى للطلب ${MIN_ORDER} جنيه. المجموع الحالي: ${orderData.total} جنيه`);
        return;
    }
    
    if(orderData.total === 0) {
        alert(lang === 'en' ? "Please add items to your cart first." : "يرجى إضافة منتجات أولاً.");
        return;
    }

    document.getElementById('orderDetails').value = orderData.details;
    document.getElementById('formTotalAmount').value = orderData.total;
    
    const btn = document.getElementById('sheetSubmitBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (lang === 'en' ? 'Processing...' : 'جاري المعالجة...');
    btn.disabled = true;
    isSubmitting = true;

    const formData = new FormData(this);

    if(SCRIPT_URL.includes("REPLACE")) {
        alert("System configuration error. Please contact support.");
        btn.innerHTML = originalText;
        btn.disabled = false;
        isSubmitting = false;
        return;
    }

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
        
        const response = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: formData,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.result !== 'success') {
            throw new Error(result.error || 'Unknown error occurred');
        }
        
        // Success
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('deliveryForm').reset();
        
        // Reset cart
        for(let k in items) { 
            items[k].count = 0; 
            const input = document.getElementById(k);
            if (input) input.value = 0;
        }
        calculateTotal();
        
        setTimeout(() => { 
            document.getElementById('successMessage').style.display = 'none'; 
        }, 5000);
        
    } catch (error) {
        console.error('Submission error:', error);
        
        let errorMsg = lang === 'en' 
            ? 'Failed to submit order. Please try WhatsApp or contact support.' 
            : 'فشل إرسال الطلب. يرجى المحاولة عبر واتساب أو الاتصال بالدعم.';
        
        if (error.name === 'AbortError') {
            errorMsg = lang === 'en' 
                ? 'Request timeout. Please check your connection and try again.' 
                : 'انتهت مهلة الطلب. يرجى التحقق من الاتصال والمحاولة مرة أخرى.';
        }
        
        alert(errorMsg);
        
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
        isSubmitting = false;
    }
});

// 6. Enhanced WhatsApp Function
function submitWhatsApp() {
    const lang = document.getElementById('mainHtml').classList.contains('lang-ar') ? 'ar' : 'en';
    const orderData = getOrderString(lang);
    
    const MIN_ORDER = 2000;
    if(orderData.total < MIN_ORDER) {
        alert(lang === 'en' 
            ? `Minimum order is ${MIN_ORDER} EGP. Current total: ${orderData.total} EGP` 
            : `الحد الأدنى للطلب ${MIN_ORDER} جنيه. المجموع الحالي: ${orderData.total} جنيه`);
        return;
    }
    
    if(orderData.total === 0) {
        alert(lang === 'en' ? "Please select items first." : "يرجى اختيار المنتجات أولاً.");
        return;
    }

    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const notes = document.getElementById('notes').value.trim();
    
    if (!name || !phone || !address) {
        alert(lang === 'en' ? "Please fill in all required fields" : "يرجى ملء جميع الحقول المطلوبة");
        return;
    }

    const greeting = lang === 'en' ? 'Hello Orgánica, New Order:' : 'مرحباً أورجانيكا، طلب جديد:';
    const totalLabel = lang === 'en' ? 'Total:' : 'المجموع:';
    const nameLabel = lang === 'en' ? 'Name:' : 'الاسم:';
    const phoneLabel = lang === 'en' ? 'Phone:' : 'الهاتف:';
    const addressLabel = lang === 'en' ? 'Address:' : 'العنوان:';
    const notesLabel = lang === 'en' ? 'Notes:' : 'ملاحظات:';

    let msg = `${greeting}\n\n${orderData.details}\n${totalLabel} ${orderData.total} EGP\n\n${nameLabel} ${name}\n${phoneLabel} ${phone}\n${addressLabel} ${address}`;
    if (notes) msg += `\n${notesLabel} ${notes}`;
    
    window.open(`https://wa.me/201067776664?text=${encodeURIComponent(msg)}`, '_blank');
}
